stages:
  - build
  - test
  - analyse
  - package
  - deploy

variables:
  SRC_DIR: src/main/webapp/static/app
  TEST_DIR: src/main/webapp/static/test
  DOCKER_STACK: docker/docker-stack.yml
  ## Development
  FRONTEND_HOST_DEV: catalogue-dev.ortolang.fr
  STACKNAME_DEV: ortolang-catalogue_vdorto
  STACK_ENV_DEV: --env VERSION=master,API_URL=https://repo-dev.ortolang.fr/api,FRONTEND_HOST=catalogue-dev.ortolang.fr,ORTOLANG_NETWORK=ortolang-vdorto
  ## PreProduction
  FRONTEND_HOST_INT: catalogue-int.ortolang.fr
  STACKNAME_INT: ortolang-catalogue_viorto
  STACK_ENV_INT: --env VERSION=latest,API_URL=https://repo-int.ortolang.fr/api,FRONTEND_HOST=catalogue-int.ortolang.fr,ORTOLANG_NETWORK=ortolang-viorto
  ## Production
  FRONTEND_HOST_PROD: catalogue.ortolang.fr
  STACKNAME_PROD: ortolang-catalogue
  STACK_ENV_PROD: --env VERSION=10.0.1-RC1,API_URL=https://repository.ortolang.fr/api,FRONTEND_HOST=catalogue.ortolang.fr,ORTOLANG_NETWORK=ortolang-vporto

include: 
  - project: 'gitlab1/gitlab-ci'
    ref: master
    file: '/docker/base_docker.yml'
  - project: 'gitlab1/gitlab-ci'
    ref: master
    file: '/npm/build.14.yml'
  - project: 'gitlab1/gitlab-ci'
    ref: master
    file: '/docker/package.yml'
  - project: 'gitlab1/gitlab-ci'
    ref: master
    file: '/docker/deploy.yml'

npm:test:
  stage: test
  image: docker:18.06
  services:
    - docker:18.06-dind
  tags:
    - ortolang-docker-bind
  script:
    - docker build -f Dockerfile.test .
  only:
    refs:
      - master
      - branches
    changes:
      - Dockerfile.test
      - config/*
      - ${SRC_DIR}/**/*
      - ${TEST_DIR}/**/*
  except:
    - production

dependency-check:scan:
  stage: test
  image: 
    name: owasp/dependency-check
    entrypoint: [""]
  services:
    - docker:18.06-dind
  tags:
    - ortolang-docker-bind
  allow_failure: true
  script:
    - mkdir -p reports/dependency-check
    - /usr/share/dependency-check/bin/dependency-check.sh -s . --format 'ALL' --data /tmp/data --out reports/dependency-check/
  artifacts:
    paths:
      - reports/dependency-check/
  only:
    refs:
      - master
    changes:
      - ${SRC_DIR}/**/*
      - ${TEST_DIR}/**/*

sonar:scan:
  stage: analyse
  image: sonarsource/sonar-scanner-cli
  tags:
    - ortolang-docker-bind
  allow_failure: true
  script:
    - sonar-scanner
  dependencies:
    - dependency-check:scan
  needs: ["dependency-check:scan"]
  only:
    refs:
      - master
    changes:
      - ${SRC_DIR}/**/*
      - ${TEST_DIR}/**/*
